<link rel="import" href="../../lib/core-localstorage/core-localstorage.html">
<link rel="import" href="../coyoho-core-ajax/coyoho-core-ajax.html">
<link rel="import" href="coyoho-login-dialog.html">
<link rel="import" href="coyoho-password-dialog.html">
<link rel="import" href="coyoho-profile-dialog.html">

<polymer-element name="coyoho-session-manager" attributes="user roles userIsAdmin connected">

  <template>

    <coyoho-login-dialog id="loginDialog" email="{{user.email}}" password="{{password}}"
                         on-login="{{login}}">
    </coyoho-login-dialog>

    <coyoho-password-dialog id="passwordDialog" password="{{newPassword}}"
                            on-submit="{{processPasswordChange}}">
    </coyoho-password-dialog>

    <coyoho-profile-dialog id="profileDialog" on-submit="{{processProfileUpdate}}">
    </coyoho-profile-dialog>

    <core-localstorage name="coyoho-session-manager:{{id}}:user" value="{{user}}"></core-localstorage>
    <core-localstorage name="coyoho-session-manager:{{id}}:connected" value="{{connected}}"
                       on-core-localstorage-load="{{connectedLoaded}}"></core-localstorage>

    <coyoho-core-ajax id="signInRequest"
                      url="/session/sign_in" method="POST" handleAs="json"
                      params='{"user[email]": "{{user.email}}", "user[password]": "{{password}}"}'
                      on-core-response="{{loginSucceeded}}" on-core-error="{{loginFailed}}">
    </coyoho-core-ajax>

    <coyoho-core-ajax id="signOutRequest"
                      url="/session/sign_out" method="GET" handleAs="json"
                      on-core-response="{{logoutSucceeded}}" on-core-error="{{logoutFailed}}">
    </coyoho-core-ajax>

    <coyoho-core-ajax id="changePasswordRequest"
                      url="/users/{{user.id}}" method="PUT" handleAs="json"
                      params='{
												"id": {{user.id}},
												"user[password]": "{{newPassword}}",
												"user[password_confirmation]": "{{newPassword}}"}'
                      on-core-response="{{passwordChangeSucceeded}}" on-core-error="{{passwordChangeFailed}}">
    </coyoho-core-ajax>

  </template>

  <script src="coyoho-session-manager.js"></script>

</polymer-element>
