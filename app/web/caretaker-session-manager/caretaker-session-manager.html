<link rel="import" href="../../web_lib/grapp-core-ajax/grapp-core-ajax.html">
<link rel="import" href="../../web_lib/core-localstorage/core-localstorage.html">
<link rel="import" href="caretaker-login-dialog.html">
<link rel="import" href="caretaker-password-dialog.html">
<link rel="import" href="caretaker-profile-dialog.html">

<polymer-element name="caretaker-session-manager" attributes="user roles userIsAdmin connected">

  <template>

    <caretaker-login-dialog id="loginDialog" email="{{user.email}}" password="{{password}}"
                            on-login="{{login}}">
    </caretaker-login-dialog>

    <caretaker-password-dialog id="passwordDialog" password="{{newPassword}}"
                               on-submit="{{processPasswordChange}}">
    </caretaker-password-dialog>

    <caretaker-profile-dialog id="profileDialog" on-submit="{{processProfileUpdate}}">
    </caretaker-profile-dialog>

    <core-localstorage name="caretaker-session-manager:{{id}}:user" value="{{user}}"></core-localstorage>
    <core-localstorage name="caretaker-session-manager:{{id}}:connected" value="{{connected}}"
                       on-core-localstorage-load="{{connectedLoaded}}"></core-localstorage>

    <grapp-core-ajax id="signInRequest"
                         url="/session/sign_in" method="POST" handleAs="json"
                         params='{"user[email]": "{{user.email}}", "user[password]": "{{password}}"}'
                         on-core-response="{{loginSucceeded}}" on-core-error="{{loginFailed}}">
    </grapp-core-ajax>

    <grapp-core-ajax id="signOutRequest"
                         url="/session/sign_out" method="GET" handleAs="json"
                         on-core-response="{{logoutSucceeded}}" on-core-error="{{logoutFailed}}">
    </grapp-core-ajax>

    <grapp-core-ajax id="changePasswordRequest"
                         url="/users/{{user.id}}" method="PUT" handleAs="json"
                         params='{
												"id": {{user.id}},
												"user[password]": "{{newPassword}}",
												"user[password_confirmation]": "{{newPassword}}"}'
                         on-core-response="{{passwordChangeSucceeded}}" on-core-error="{{passwordChangeFailed}}">
    </grapp-core-ajax>

  </template>

  <script src="caretaker-session-manager.js"></script>

</polymer-element>
